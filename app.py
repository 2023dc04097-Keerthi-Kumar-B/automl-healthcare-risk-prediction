import streamlit as st
import pandas as pd
import joblib

st.set_page_config(page_title="Stroke Risk Prediction", layout="centered")

st.title("Stroke Risk Prediction App")
st.write(
    """
    This application predicts the **risk of stroke** based on patient health,
    lifestyle, and demographic information using a trained Machine Learning model.
    """
)

st.subheader("Enter Patient Details")

# Load trained model and preprocessing objects
model = joblib.load("models/logistic_regression_model.pkl")
scaler = joblib.load("models/standard_scaler.pkl")
feature_columns = joblib.load("models/feature_columns.pkl")

# Create a streamlit form
with st.form("patient_form"):
    age = st.number_input("Age", min_value=0, max_value=120, value=45)
    
    gender = st.selectbox(
        "Gender",
        options=["Male", "Female"]
    )
    
    bmi = st.number_input("Body Mass Index (BMI)", min_value=10.0, max_value=60.0, value=25.0)
    
    avg_glucose = st.number_input(
        "Average Glucose Level",
        min_value=50.0,
        max_value=300.0,
        value=100.0
    )
    
    hypertension = st.selectbox(
        "Hypertension",
        options=["No", "Yes"]
    )
    
    heart_disease = st.selectbox(
        "Heart Disease",
        options=["No", "Yes"]
    )
    
    smoking_status = st.selectbox(
        "Smoking Status",
        options=["never smoked", "formerly smoked", "smokes"]
    )
    
    work_type = st.selectbox(
        "Work Type",
        options=["Private", "Self-employed", "Govt_job"]
    )
    
    residence_type = st.selectbox(
        "Residence Type",
        options=["Urban", "Rural"]
    )

    submit_button = st.form_submit_button("Predict Stroke Risk")

# Create a single-row DataFrame from inputs
if submit_button:
    input_data = {
        "age": age,
        "avg_glucose_level": avg_glucose,
        "bmi": bmi,
        "hypertension": 1 if hypertension == "Yes" else 0,
        "heart_disease": 1 if heart_disease == "Yes" else 0,
        "gender": gender,
        "work_type": work_type,
        "Residence_type": residence_type,
        "smoking_status": smoking_status
    }

    input_df = pd.DataFrame([input_data])

    # Derive bmi_category (same logic as training)
    def bmi_category(bmi):
        if bmi < 18.5:
            return "Underweight"
        elif bmi < 25:
            return "Normal"
        elif bmi < 30:
            return "Overweight"
        else:
            return "Obese"

    input_df["bmi_category"] = input_df["bmi"].apply(bmi_category)

    # One-hot encode categorical features
    categorical_cols = [
        "gender",
        "work_type",
        "Residence_type",
        "smoking_status",
        "bmi_category"
    ]

    input_df_encoded = pd.get_dummies(input_df, columns=categorical_cols)

    # Align input features with training feature columns
    # Add missing columns with 0
    for col in feature_columns:
        if col not in input_df_encoded.columns:
            input_df_encoded[col] = 0

    # Ensure correct column order
    input_df_encoded = input_df_encoded[feature_columns]

    # Scale numerical features
    input_scaled = scaler.transform(input_df_encoded)

    # Generating prediction and probability & Risk categorization based on probability
    prediction = model.predict(input_scaled)[0]
    probability = model.predict_proba(input_scaled)[0][1]  # P(stroke)
    if probability < 0.10:
        risk_category = "LOW RISK"
        risk_color = "green"
    elif probability < 0.30:
        risk_category = "MODERATE RISK"
        risk_color = "orange"
    else:
        risk_category = "HIGH RISK"
        risk_color = "red"


    # Display results clearly in streamlit
    st.subheader("Prediction Result")

    stroke_risk_percent = probability * 100

    st.metric(
        label="Estimated Stroke Risk",
        value=f"{stroke_risk_percent:.2f}%"
    )

    if risk_category == "LOW RISK":
        st.success(f"ðŸŸ¢ Risk Category: {risk_category}")
    elif risk_category == "MODERATE RISK":
        st.warning(f"ðŸŸ  Risk Category: {risk_category}")
    else:
        st.error(f"ðŸ”´ Risk Category: {risk_category}")

    st.caption(
        "Note: Risk category is derived from predicted probability and is intended for screening purposes."
    )

    label_text = "Stroke" if prediction == 1 else "No Stroke"
    st.write(f"**Model Classification:** {label_text}")

    # Add disclaimer
    st.info(
        "âš ï¸ Disclaimer: This prediction is generated by a machine learning model "
        "and is intended for educational purposes only. It should not be used as a "
        "medical diagnosis."
    )




